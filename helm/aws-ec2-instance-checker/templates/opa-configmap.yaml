apiVersion: v1
data:
  check_imdsv1.rego: |
    package ec2

    default excessive_permission = false

    # Check if an instance's associated role allows all actions on all resources
    excessive_permission {
        input.Role.Policy.Statement[_].Effect == "Allow"
        input.Role.Policy.Statement[_].Action == "*"
        input.Role.Policy.Statement[_].Resource == "*"
    }

    default match = false

    match {
        input.MetadataOptions.HttpTokens == "optional"
        input.PublicIpAddress != null
        excessive_permission
    }
kind: ConfigMap
metadata:
  creationTimestamp: null
  name: opa-policy
